--<ScriptOptions statementTerminator="@">
CREATE OR REPLACE PROCEDURE TFSDB2S.GET_CICLS(IN P_DATE TIMESTAMP)
SPECIFIC GET_CICLS
DYNAMIC RESULT SETS 1
LANGUAGE SQL
--######################################################################################################
--# Description:    Retrieves records used for CICLS Handoff File
--# Created by:     Cedrick C. Nungay 
--# Date created:   02/08/2024
--######################################################################################################
--# Input:  P_DATE  :   Process date
--######################################################################################################
P1: BEGIN
    DECLARE C_CICLS CURSOR WITH RETURN FOR
        WITH IRR_RATES AS (SELECT JFXDCD, JFXDCR FROM TFSDB2S.JHFXDT WHERE JFXDBC = 'PHP' AND JFXDRN = 3)
        SELECT A.CIFNO AS "CLIENT_NUMBER",
            CASE WHEN B.CFINDI = 'Y'
                THEN COALESCE(TRIM(B.CFNA1A), '') || ' ' || COALESCE(TRIM(B.CFNA1B),'') || ' ' || COALESCE(TRIM(B.CFNA1), '')
                WHEN B.CFINDI = 'N' THEN B.CL_NAME ELSE ''
            END AS "CLIENT_NAME",
            TRIM(B.CFTINN) AS "TIN_NUMBER",
            '0' AS TRAN_TYPE,
            A.CREATED_DATE PROCESS_DATE,
            C.CICLS_PRODUCT_CODE,
            A.ORGLMT_IRR AS "APPROVED_AMOUNT",
            A.TOSBAL_IRR AS "OUTSTANDING_CURRENT",
            0 AS "OUTSTANDING_PAST_DUE"
        FROM TFSDB2S.LNCLST_CICLS A
        LEFT JOIN TFSDB2S.CFMAST B
            ON A.CIFNO = B.CFCIF#
        LEFT JOIN TFSDB2S.PROD_PAYMNT_CICLS_MAPPING C
            ON A.PRODUCT_ID = C.PROD_ID
        LEFT JOIN TFSDB2S.LNAPPF D
            ON A.AFCPNO = D.AFCPNO
        UNION ALL
        SELECT A.CIFNO, B.CFSNME SHORTNAME, B.CFTINN, '0', A.CREATED_DATE, C.CICLS_PRODUCT_CODE
             , A.LORGAMT
             , A.LPMTAMT
             , A.OUTSTANDING_PAST_DUE
        FROM TFSDB2S.LNTFINT_CICLS A
        INNER JOIN TFSDB2S.CFMAST B
            ON A.CIFNO = B.CFCIF#
        LEFT JOIN TFSDB2S.PROD_PAYMNT_CICLS_MAPPING C
            ON A.PRODUCT_ID = C.PROD_ID
        INNER JOIN PAYMENTDETAIL D
            ON A.ACCTNO = D.PNNUMBER
        LEFT JOIN TFSDB2S.LNAPPF E
            ON D.FACILITYREFERENCENUMBER = E.AFCPNO
        ;

    OPEN C_CICLS;
END P1@

CALL TFSDB2S.GET_CICLS(NOW())@